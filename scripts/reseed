#!/usr/bin/env bash
this_dir=$(cd $(dirname "$0"); pwd) # this script's directory
this_script=$(basename $0)
workspace_root=$(cd "$this_dir/.."; pwd)

#-e: Exits immediately if any command returns a non-zero status (i.e., fails)
#-u: Treats unset variables as errors and exits immediately
#-o pipefail: If any command in a pipeline fails, the entire pipeline fails
set -euo pipefail

help () {
  echo
  cat << END_DOC
USAGE: $this_script [OPTIONS]

Runs the database seed script inside the running app container.
Use this after modifying data files (gpu-data, news-data, etc.) to update the database.

Options:
  -h, --help    Show this help message

END_DOC
}

die () {
    echo "*** ERROR ***"
    echo >&2 "ERROR: $@"
    help
    exit 1
}

check_minikube() {
    if ! command -v minikube &> /dev/null; then
        die "minikube is not installed. Install it with: brew install minikube"
    fi

    if ! minikube status &> /dev/null; then
        die "minikube is not running. Start it with: ./scripts/dev"
    fi
}

reseed() {
    echo "Running database seed in app container..."
    minikube kubectl -- exec -it -n gpupoet-dev deploy/app -- npm run prisma-seed --workspace=packages/web-app
    echo "Database seed completed!"
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            help
            exit 0
            ;;
        *)
            die "Unknown option: $1"
            ;;
    esac
done

cd "$workspace_root"

echo "=== Reseeding GPUPoet Database ==="

check_minikube
reseed

echo "Reseed completed!"
