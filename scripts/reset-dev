#!/usr/bin/env bash
this_dir=$(cd $(dirname "$0"); pwd) # this script's directory
this_script=$(basename $0)
workspace_root=$(cd "$this_dir/.."; pwd)

#-e: Exits immediately if any command returns a non-zero status (i.e., fails)
#-u: Treats unset variables as errors and exits immediately
#-o pipefail: If any command in a pipeline fails, the entire pipeline fails
set -euo pipefail

help () {
  echo
  cat << END_DOC
USAGE: $this_script [OPTIONS]

Completely resets the GPUPoet development environment.

WARNING: This is a DESTRUCTIVE operation that will:
   - Delete the gpupoet-dev namespace and all resources
   - Delete the minikube cluster
   - Remove all persistent volumes and data
   - Clear any cached Docker images

This cannot be undone!

Options:
  -f, --force   Skip confirmation prompt
  -h, --help    Show this help message

END_DOC
}

die () {
    echo "*** ERROR ***"
    echo >&2 "ERROR: $@"
    help
    exit 1
}

confirm_reset() {
    echo "WARNING: This will completely reset your development environment!"
    echo ""
    echo "This will:"
    echo "  - Delete the gpupoet-dev namespace and all resources"
    echo "  - Delete the minikube cluster"
    echo "  - Remove all persistent volumes and database data"
    echo "  - Clear cached Docker images"
    echo ""
    echo "This operation CANNOT be undone!"
    echo ""
    read -p "Are you sure you want to continue? Type 'yes' to confirm: " -r
    if [[ ! $REPLY =~ ^yes$ ]]; then
        echo "Reset cancelled."
        exit 0
    fi
}

reset_development() {
    echo "=== Resetting GPUPoet Development Environment ==="

    # Check if minikube is available
    if command -v minikube &> /dev/null; then
        echo "Stopping and deleting minikube cluster..."
        minikube delete || true
    else
        echo "Minikube not found, skipping minikube cleanup"
    fi

    # Check if kubectl is available and clean up any remaining resources
    if command -v kubectl &> /dev/null; then
        echo "Cleaning up any remaining Kubernetes resources..."
        kubectl delete namespace gpupoet-dev --ignore-not-found=true || true
    fi

    # Clean up Docker images if Docker is available
    if command -v docker &> /dev/null; then
        echo "Cleaning up gpupoet Docker images..."
        docker rmi gpupoet-dev:latest 2>/dev/null || true
        docker rmi $(docker images -q --filter "reference=gpupoet*") 2>/dev/null || true
    fi

    echo ""
    echo "Development environment reset complete!"
    echo ""
    echo "To start fresh, run: ./scripts/dev"
}

# Parse arguments
force=false
while [[ $# -gt 0 ]]; do
    case $1 in
        -f|--force)
            force=true
            shift
            ;;
        -h|--help)
            help
            exit 0
            ;;
        *)
            die "Unknown option: $1"
            ;;
    esac
done

cd "$workspace_root"

if [[ "$force" != "true" ]]; then
    confirm_reset
fi

reset_development
