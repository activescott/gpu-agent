// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL") // uses connection pooling
  directUrl = env("POSTGRES_URL_NON_POOLING") // uses a direct connection
}

model gpu {
  // unique name for the card; also primary key
  name     String  @id @unique
  label    String
  series   String?
  // GPU market segment: "gaming" (consumer), "workstation" (professional), "datacenter" (enterprise/AI)
  category String?

  // Specs (LEGACY - being migrated to GpuMetricValue):
  tensorCoreCount             Float?
  fp32TFLOPS                  Float
  fp16TFLOPS                  Float
  int8TOPS                    Float?
  memoryCapacityGB            Float
  memoryBandwidthGBs          Float
  // maximum thermal design power was added later and not all GPUs have it listed in our DB. See the seed.
  maxTDPWatts                 Float?
  gpuArchitecture             String
  // This is a list of the supported precisions for hardware-accelerated generalized matrix multiplication operations (GEMM).
  supportedHardwareOperations String[]

  // The compute capability of a device is represented by a version number, also sometimes called its "SM version". This version number identifies the features supported by the GPU hardware and is used by applications at runtime to determine which hardware features and/or instructions are available on the present GPU.
  // CUDA Compute Capability references:
  // - https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#compute-capability
  // - https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#compute-capabilities
  // - https://developer.nvidia.com/cuda-gpus <<< GPU list
  supportedCUDAComputeCapability Float?

  // references for the specs:
  references        String[]
  // custom-written summary for the GPU. Used on info pages
  summary           String @default("")
  // Release date of the GPU (e.g., "2022-10-12")
  releaseDate       String?
  // Last modified timestamp for the GPU spec data (from YAML file)
  lastModified      DateTime @default(now())
  // Manufacturer's Suggested Retail Price in USD
  msrpUSD           Float?
  // Notes about the GPU specs (e.g., MSRP sources, calculation explanations)
  notes             String[]

  // Manufacturer identifiers (NVPN, OPN, board_id, etc.) stored as JSON array
  manufacturerIdentifiers Json?  @db.JsonB
  // Third-party product information (Dell, ASUS, etc.) stored as JSON array
  thirdPartyProducts      Json?  @db.JsonB

  // Relations
  metricValues  GpuMetricValue[]
  Listing       Listing[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([name])
}

// Stores metadata about each metric (both specs and benchmarks)
model MetricDefinition {
  slug              String   @id  // e.g., "fp32-tflops", "counter-strike-2-fps-3840x2160"
  name              String       // e.g., "FP32 TFLOPS", "Counter-Strike 2 (4K)"
  category          String       // "ai" or "gaming"
  metricType        String       // "spec" or "benchmark"
  unit              String       // e.g., "TFLOPS", "FPS"
  unitShortest      String       // e.g., "TFLOPS", "FPS"
  description       String       // Full description for learn pages
  descriptionDollarsPer String   // Description for $/metric pages

  // For benchmarks: source info (optional, only used for benchmarks)
  benchmarkId       String?      // e.g., "cs2", "3dmark"
  benchmarkName     String?      // e.g., "Counter-Strike 2"
  configuration     String?      // e.g., "Resolution: 3840 x 2160"
  configurationId   String?      // e.g., "pts-cs2-1-0-x-resolution-3840-x-2160"

  // For specs: maps to field name in gpu-specs YAML
  gpuField          String?      // e.g., "fp32TFLOPS"

  values            GpuMetricValue[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// Stores actual metric values for each GPU
model GpuMetricValue {
  id          String   @id @default(cuid())
  gpuName     String
  gpu         gpu      @relation(fields: [gpuName], references: [name], onDelete: Cascade)
  metricSlug  String
  metric      MetricDefinition @relation(fields: [metricSlug], references: [slug], onDelete: Cascade)
  value       Float

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([gpuName, metricSlug])
  @@index([metricSlug])
  @@index([gpuName])
}

model Listing {
  id         String  @id @default(cuid())
  itemId     String  // eBay's item ID (no longer unique due to versioning)
  version    Int     @default(1)
  // we use this as a soft-delete for archiving historical versions
  // ebay doesn't provide the sold status of an item - the items just don't come back from the search endpoints.
  // so we use this to mark items as stale and not return them.
  stale      Boolean @default(false)
  // new archiving fields for historical data tracking
  archived   Boolean   @default(false)
  archivedAt DateTime?

  title                    String
  priceValue               String
  priceCurrency            String
  buyingOptions            String[] // e.g. | "FIXED_PRICE" | "AUCTION" | "BEST_OFFER" | "CLASSIFIED_AD"
  imageUrl                 String
  adultOnly                Boolean
  itemHref                 String
  leafCategoryIds          String[]
  listingMarketplaceId     String?
  sellerUsername           String
  sellerFeedbackPercentage String
  sellerFeedbackScore      Int
  condition                String?
  conditionId              String?
  itemAffiliateWebUrl      String
  // we flatten these from a list.
  thumbnailImageUrl        String
  epid                     String
  itemCreationDate         DateTime?
  itemLocationCountry      String?
  itemGroupType            String?

  // relation per https://www.prisma.io/docs/concepts/components/prisma-schema/relations/one-to-many-relations
  // when gpu is deleted, so are its listings
  gpu     gpu    @relation(fields: [gpuName], references: [name], onDelete: NoAction, onUpdate: Cascade)
  gpuName String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  // note cachedAt is essentially createdAt but allows us to use it explicitly and potentially update it separately from createdAt or updatedAt
  cachedAt DateTime   @default(now())

  @@index([itemId, version])
  @@index([gpuName, archived, cachedAt])
  @@index([gpuName, stale])
}

enum NewsStatus {
  DRAFT
  PUBLISHED
}

model NewsArticle {
  id              String     @id @default(cuid(2))
  slug            String
  title           String
  content         String     @db.Text
  status          NewsStatus @default(DRAFT)
  tags            String[]
  authorFullName  String     // This would link to your user system

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  publishedAt     DateTime?

  @@index([id, status, publishedAt])

}
