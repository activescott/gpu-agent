#!/usr/bin/env bash
this_dir=$(cd $(dirname "$0"); pwd) # this script's directory
this_script=$(basename $0)
workspace_root=$(cd "$this_dir/.."; pwd)

#-e: Exits immediately if any command returns a non-zero status (i.e., fails)
#-u: Treats unset variables as errors and exits immediately
#-o pipefail: If any command in a pipeline fails, the entire pipeline fails
set -euo pipefail

help () {
  echo
  cat << END_DOC
USAGE: $this_script [COMMAND] [OPTIONS]

Runs Prisma commands inside the app container in Kubernetes.

Commands:
  migrate dev [--name NAME]   Create and apply a new migration (development only)
  migrate deploy              Apply pending migrations (production safe)
  migrate reset               Reset database and re-run all migrations + seed
  migrate status              Show status of migrations
  seed                        Run the seed script
  studio                      Open Prisma Studio (database GUI)
  generate                    Generate Prisma client

Options:
  -h, --help    Show this help message

Examples:
  $this_script migrate dev --name add-user-table
  $this_script migrate deploy
  $this_script migrate reset
  $this_script seed
  $this_script studio

END_DOC
}

die () {
    echo "*** ERROR ***"
    echo >&2 "ERROR: $@"
    help
    exit 1
}

check_minikube() {
    if ! command -v minikube &> /dev/null; then
        die "minikube is not installed. Install it with: brew install minikube"
    fi

    if ! minikube status &> /dev/null; then
        die "minikube is not running. Start it with: ./scripts/dev"
    fi
}

get_app_pod() {
    local pod=$(minikube kubectl -- get pods -n gpupoet-dev -l app=app -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
    if [[ -z "$pod" ]]; then
        die "No app pod found. Is the dev server running? Start it with: ./scripts/dev"
    fi
    echo "$pod"
}

run_in_container() {
    local pod=$(get_app_pod)
    local cmd="$@"

    echo "Running in pod $pod: $cmd"
    echo "---"
    minikube kubectl -- exec "$pod" -n gpupoet-dev -- sh -c "cd /app/packages/web-app && $cmd"
}

# Parse arguments
if [[ $# -eq 0 ]]; then
    help
    exit 0
fi

cd "$workspace_root"

check_minikube

case $1 in
    -h|--help)
        help
        exit 0
        ;;
    migrate)
        shift
        if [[ $# -eq 0 ]]; then
            # No subcommand, just run prisma migrate
            run_in_container "npx prisma migrate"
            exit 0
        fi
        subcommand="$1"
        shift
        case $subcommand in
            dev)
                # Special handling for dev: sync migration files back to local filesystem
                # Collect remaining args and extract migration name
                args=""
                migration_name=""
                while [[ $# -gt 0 ]]; do
                    if [[ "$1" == "--name" && $# -gt 1 ]]; then
                        args="$args $1 $2"
                        migration_name="$2"
                        shift 2
                    else
                        args="$args $1"
                        shift
                    fi
                done

                # Get list of migrations before
                local_migrations_dir="packages/web-app/prisma/migrations"
                container_migrations_dir="/app/packages/web-app/prisma/migrations"
                pod=$(get_app_pod)
                before_migrations=$(minikube kubectl -- exec "$pod" -n gpupoet-dev -- ls "$container_migrations_dir" 2>/dev/null | sort)

                # Run the migration
                run_in_container "npx prisma migrate dev $args"

                # Get list of migrations after
                after_migrations=$(minikube kubectl -- exec "$pod" -n gpupoet-dev -- ls "$container_migrations_dir" 2>/dev/null | sort)

                # Find new migrations and copy them back
                new_migrations=$(comm -13 <(echo "$before_migrations") <(echo "$after_migrations"))
                if [[ -n "$new_migrations" ]]; then
                    echo ""
                    echo "=== Syncing new migrations to local filesystem ==="
                    for migration in $new_migrations; do
                        if [[ "$migration" == "migration_lock.toml" ]]; then
                            continue
                        fi
                        echo "Copying migration: $migration"
                        mkdir -p "$local_migrations_dir/$migration"
                        minikube kubectl -- cp "gpupoet-dev/${pod}:${container_migrations_dir}/${migration}/migration.sql" "$local_migrations_dir/$migration/migration.sql"
                        echo "  -> $local_migrations_dir/$migration/migration.sql"
                    done
                    echo ""
                    echo "New migrations synced to local filesystem. Don't forget to commit them!"
                fi
                ;;
            reset)
                # Confirmation prompt for destructive operation
                echo "WARNING: This will reset the database and delete all data!"
                read -p "Are you sure? (yes/no): " confirm
                if [[ "$confirm" != "yes" ]]; then
                    echo "Aborted."
                    exit 0
                fi
                run_in_container "npx prisma migrate reset --force"
                ;;
            *)
                # Pass any other migrate subcommand directly to prisma
                run_in_container "npx prisma migrate $subcommand $@"
                ;;
        esac
        ;;
    *)
        # Pass any other command directly to prisma
        run_in_container "npx prisma $@"
        ;;
esac

echo ""
echo "Done!"
